<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com https://www.gstatic.com;
        style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
        img-src 'self' data: https: blob:;
        connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.cloudfunctions.net wss://*.firebaseio.com https://ui-avatars.com;
        font-src 'self' data:;
        media-src 'self' blob:;
    ">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>ProConnect Messenger - Ultra Secured</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase v9 Compat with SRI -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- CryptoJS for end-to-end encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: text;
        }
        .scroll-smooth {
            scroll-behavior: smooth;
        }
        .chat-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .chat-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .chat-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .chat-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }
        .local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border-radius: 12px;
            border: 2px solid white;
            object-fit: cover;
            z-index: 10;
        }
        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .typing-dot {
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* Security watermark */
        .security-watermark {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 9999;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div class="security-watermark">üîí Ultra Secured</div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;

        // ==================== SECURITY LAYER ====================
        
        // Security Configuration
        const SECURITY_CONFIG = {
            MAX_LOGIN_ATTEMPTS: 5,
            LOGIN_TIMEOUT: 900000, // 15 minutes
            SESSION_TIMEOUT: 3600000, // 1 hour
            MAX_MESSAGE_LENGTH: 5000,
            MAX_FILE_SIZE: 5 * 1024 * 1024, // 5MB
            ALLOWED_IMAGE_TYPES: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
            RATE_LIMIT_WINDOW: 60000, // 1 minute
            MAX_REQUESTS_PER_WINDOW: 30,
            PASSWORD_MIN_LENGTH: 8,
            ENCRYPTION_KEY: 'ProConnect-E2E-Encryption-Key-2024', // In production, use secure key management
        };

        // Security Utility Class
        class SecurityManager {
            constructor() {
                this.loginAttempts = new Map();
                this.requestCounts = new Map();
                this.sessionStart = Date.now();
                this.csrfToken = this.generateCSRFToken();
            }

            // Generate CSRF Token
            generateCSRFToken() {
                return CryptoJS.lib.WordArray.random(32).toString();
            }

            // Validate CSRF Token
            validateCSRFToken(token) {
                return token === this.csrfToken;
            }

            // Input Sanitization - Prevent XSS
            sanitizeInput(input) {
                if (typeof input !== 'string') return '';
                return input
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;')
                    .replace(/\//g, '&#x2F;')
                    .trim();
            }

            // HTML Sanitization for display
            sanitizeHTML(html) {
                const div = document.createElement('div');
                div.textContent = html;
                return div.innerHTML;
            }

            // Validate Email
            validateEmail(email) {
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                return emailRegex.test(email) && email.length <= 254;
            }

            // Validate Password Strength
            validatePassword(password) {
                if (password.length < SECURITY_CONFIG.PASSWORD_MIN_LENGTH) {
                    return { valid: false, message: 'Password must be at least 8 characters' };
                }
                if (!/[A-Z]/.test(password)) {
                    return { valid: false, message: 'Password must contain at least one uppercase letter' };
                }
                if (!/[a-z]/.test(password)) {
                    return { valid: false, message: 'Password must contain at least one lowercase letter' };
                }
                if (!/[0-9]/.test(password)) {
                    return { valid: false, message: 'Password must contain at least one number' };
                }
                if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                    return { valid: false, message: 'Password must contain at least one special character' };
                }
                return { valid: true, message: 'Password is strong' };
            }

            // Track Login Attempts
            trackLoginAttempt(email) {
                const attempts = this.loginAttempts.get(email) || { count: 0, lastAttempt: Date.now() };
                const now = Date.now();
                
                // Reset if timeout passed
                if (now - attempts.lastAttempt > SECURITY_CONFIG.LOGIN_TIMEOUT) {
                    attempts.count = 0;
                }
                
                attempts.count++;
                attempts.lastAttempt = now;
                this.loginAttempts.set(email, attempts);
                
                return attempts.count;
            }

            // Check if account is locked
            isAccountLocked(email) {
                const attempts = this.loginAttempts.get(email);
                if (!attempts) return false;
                
                const now = Date.now();
                if (now - attempts.lastAttempt > SECURITY_CONFIG.LOGIN_TIMEOUT) {
                    this.loginAttempts.delete(email);
                    return false;
                }
                
                return attempts.count >= SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS;
            }

            // Reset login attempts on successful login
            resetLoginAttempts(email) {
                this.loginAttempts.delete(email);
            }

            // Rate Limiting
            checkRateLimit(userId) {
                const now = Date.now();
                const userRequests = this.requestCounts.get(userId) || [];
                
                // Remove old requests outside the window
                const recentRequests = userRequests.filter(timestamp => 
                    now - timestamp < SECURITY_CONFIG.RATE_LIMIT_WINDOW
                );
                
                if (recentRequests.length >= SECURITY_CONFIG.MAX_REQUESTS_PER_WINDOW) {
                    return false;
                }
                
                recentRequests.push(now);
                this.requestCounts.set(userId, recentRequests);
                return true;
            }

            // Session Timeout Check
            isSessionValid() {
                return Date.now() - this.sessionStart < SECURITY_CONFIG.SESSION_TIMEOUT;
            }

            // Refresh session
            refreshSession() {
                this.sessionStart = Date.now();
            }

            // End-to-End Encryption
            encryptMessage(message, key = SECURITY_CONFIG.ENCRYPTION_KEY) {
                try {
                    return CryptoJS.AES.encrypt(message, key).toString();
                } catch (error) {
                    console.error('Encryption error:', error);
                    return null;
                }
            }

            // Decrypt Message
            decryptMessage(encryptedMessage, key = SECURITY_CONFIG.ENCRYPTION_KEY) {
                try {
                    const bytes = CryptoJS.AES.decrypt(encryptedMessage, key);
                    return bytes.toString(CryptoJS.enc.Utf8);
                } catch (error) {
                    console.error('Decryption error:', error);
                    return '[Encrypted Message]';
                }
            }

            // Validate File Upload
            validateFile(file) {
                if (!file) return { valid: false, message: 'No file selected' };
                
                if (!SECURITY_CONFIG.ALLOWED_IMAGE_TYPES.includes(file.type)) {
                    return { valid: false, message: 'Invalid file type. Only images allowed.' };
                }
                
                if (file.size > SECURITY_CONFIG.MAX_FILE_SIZE) {
                    return { valid: false, message: 'File too large. Max size is 5MB.' };
                }
                
                return { valid: true, message: 'File is valid' };
            }

            // Secure Random String
            generateSecureRandom(length = 32) {
                return CryptoJS.lib.WordArray.random(length).toString();
            }

            // Hash data
            hashData(data) {
                return CryptoJS.SHA256(data).toString();
            }

            // Detect suspicious activity
            detectSuspiciousActivity(action, metadata = {}) {
                // Log suspicious activities
                console.warn('Security Monitor:', {
                    action,
                    timestamp: new Date().toISOString(),
                    metadata
                });
                
                // In production, send to security monitoring service
            }

            // SQL Injection Prevention (for any future backend integration)
            sanitizeQuery(query) {
                return query.replace(/['";\\]/g, '');
            }

            // Content Security Policy Violation Handler
            handleCSPViolation(violation) {
                console.error('CSP Violation:', violation);
                this.detectSuspiciousActivity('csp_violation', violation);
            }
        }

        // Initialize Security Manager
        const securityManager = new SecurityManager();

        // CSP Violation Reporting
        document.addEventListener('securitypolicyviolation', (e) => {
            securityManager.handleCSPViolation({
                blockedURI: e.blockedURI,
                violatedDirective: e.violatedDirective,
                originalPolicy: e.originalPolicy,
            });
        });

        // ==================== FIREBASE CONFIGURATION ====================

        const firebaseConfig = {
            apiKey: 'AIzaSyCYYzVnVB0JheAYre5c21d_xWv1HabIRPM',
            authDomain: 'brainy-18fda.firebaseapp.com',
            databaseURL: 'https://brainy-18fda-default-rtdb.firebaseio.com',
            projectId: 'brainy-18fda',
            storageBucket: 'brainy-18fda.firebasestorage.app',
            messagingSenderId: '659063130521',
            appId: '1:659063130521:web:938a8b6f32506dc4aceb08',
            measurementId: 'G-M1X3YW1SZF'
        };

        let auth, db, storage;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            
            // Enable persistence with security
            db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.log('Persistence failed: Multiple tabs open');
                } else if (err.code === 'unimplemented') {
                    console.log('Persistence not available');
                }
            });
        } catch (error) {
            console.error('Firebase initialization error:', error);
            securityManager.detectSuspiciousActivity('firebase_init_error', { error: error.message });
        }

        // ==================== UTILITY FUNCTIONS ====================

        const AuthContext = createContext();
        const useAuth = () => useContext(AuthContext);

        const STUN_SERVERS = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        const generateShareCode = () => {
            return securityManager.generateSecureRandom(3).toUpperCase();
        };

        const getChatId = (uid1, uid2) => {
            return [uid1, uid2].sort().join('_');
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                if (isNaN(date.getTime())) return '';
                
                const now = new Date();
                const diff = now - date;
                
                if (diff < 0) return 'Just now';
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
                
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } catch (error) {
                console.error('Timestamp formatting error:', error);
                return '';
            }
        };

        // ==================== COMPONENTS ====================

        // Toast Component
        const Toast = ({ message, type = 'info', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';

            return (
                <div className={`fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in`}>
                    <div className="flex items-center space-x-2">
                        {type === 'error' && <span>‚ö†Ô∏è</span>}
                        {type === 'success' && <span>‚úÖ</span>}
                        {type === 'info' && <span>‚ÑπÔ∏è</span>}
                        <span>{message}</span>
                    </div>
                </div>
            );
        };

        // Auth Provider Component
        const AuthProvider = ({ children }) => {
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const sessionCheckRef = useRef(null);

            useEffect(() => {
                if (!auth) {
                    console.error('Firebase Auth not initialized');
                    setLoading(false);
                    return;
                }
                
                const unsubscribe = auth.onAuthStateChanged(
                    (user) => {
                        setCurrentUser(user);
                        
                        if (user) {
                            // Update online status securely
                            db.collection('users').doc(user.uid).set({
                                online: true,
                                lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                                lastActivity: Date.now()
                            }, { merge: true }).catch(err => {
                                console.error('Error updating status:', err);
                                securityManager.detectSuspiciousActivity('status_update_error', { error: err.message });
                            });

                            // Reset session timer
                            securityManager.refreshSession();
                        }
                        
                        setLoading(false);
                    },
                    (error) => {
                        console.error('Auth state change error:', error);
                        securityManager.detectSuspiciousActivity('auth_state_error', { error: error.message });
                        setLoading(false);
                    }
                );
                
                // Session timeout checker
                sessionCheckRef.current = setInterval(() => {
                    if (auth.currentUser && !securityManager.isSessionValid()) {
                        auth.signOut().then(() => {
                            alert('Session expired. Please login again.');
                        }).catch(err => console.error('Logout error:', err));
                    }
                }, 60000); // Check every minute
                
                // Handle page unload
                const handleUnload = () => {
                    if (auth.currentUser) {
                        db.collection('users').doc(auth.currentUser.uid).update({
                            online: false,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        }).catch(err => console.error('Error updating status:', err));
                    }
                };
                
                // Prevent context menu (right-click)
                const handleContextMenu = (e) => {
                    if (!e.target.matches('input, textarea')) {
                        e.preventDefault();
                    }
                };
                
                window.addEventListener('beforeunload', handleUnload);
                document.addEventListener('contextmenu', handleContextMenu);
                
                return () => {
                    if (unsubscribe) unsubscribe();
                    if (sessionCheckRef.current) clearInterval(sessionCheckRef.current);
                    window.removeEventListener('beforeunload', handleUnload);
                    document.removeEventListener('contextmenu', handleContextMenu);
                };
            }, []);

            const value = { currentUser };

            return (
                <AuthContext.Provider value={value}>
                    {!loading ? children : (
                        <div className="min-h-screen flex items-center justify-center bg-gray-100">
                            <div className="text-center">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <p className="text-gray-600">üîí Initializing Secure Connection...</p>
                            </div>
                        </div>
                    )}
                </AuthContext.Provider>
            );
        };

        // Enhanced Auth Component with Security
        const AuthPage = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [toast, setToast] = useState(null);
            const [passwordStrength, setPasswordStrength] = useState(null);
            const [showPassword, setShowPassword] = useState(false);

            const showToast = (message, type = 'info') => {
                setToast({ message, type });
            };

            const handlePasswordChange = (value) => {
                setPassword(value);
                if (!isLogin && value) {
                    const validation = securityManager.validatePassword(value);
                    setPasswordStrength(validation);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // Sanitize inputs
                const sanitizedEmail = securityManager.sanitizeInput(email).toLowerCase();
                const sanitizedPassword = password; // Don't sanitize password
                
                // Validate email
                if (!securityManager.validateEmail(sanitizedEmail)) {
                    showToast('Invalid email format', 'error');
                    return;
                }
                
                // Check if account is locked
                if (securityManager.isAccountLocked(sanitizedEmail)) {
                    showToast('Account locked due to multiple failed attempts. Try again later.', 'error');
                    return;
                }
                
                // Validate password for signup
                if (!isLogin) {
                    const passwordValidation = securityManager.validatePassword(sanitizedPassword);
                    if (!passwordValidation.valid) {
                        showToast(passwordValidation.message, 'error');
                        return;
                    }
                }
                
                setLoading(true);

                try {
                    if (isLogin) {
                        const userCredential = await auth.signInWithEmailAndPassword(sanitizedEmail, sanitizedPassword);
                        
                        // Reset login attempts on success
                        securityManager.resetLoginAttempts(sanitizedEmail);
                        
                        await db.collection('users').doc(userCredential.user.uid).set({
                            online: true,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLoginIP: 'hidden', // In production, get actual IP
                            lastLoginTime: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        
                        showToast('Login successful! üîí', 'success');
                    } else {
                        const userCredential = await auth.createUserWithEmailAndPassword(sanitizedEmail, sanitizedPassword);
                        const user = userCredential.user;
                        
                        // Generate secure share code
                        const shareCode = generateShareCode();
                        
                        await db.collection('users').doc(user.uid).set({
                            uid: user.uid,
                            email: user.email,
                            shareCode: shareCode,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            friendsList: [],
                            online: true,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                            accountCreatedIP: 'hidden',
                            securityLevel: 'ultra-high'
                        });
                        
                        showToast('Account created successfully! üéâ', 'success');
                    }
                } catch (error) {
                    console.error('Auth error:', error);
                    
                    // Track failed login attempt
                    if (isLogin) {
                        const attempts = securityManager.trackLoginAttempt(sanitizedEmail);
                        const remaining = SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS - attempts;
                        
                        if (remaining > 0) {
                            showToast(`Login failed. ${remaining} attempts remaining.`, 'error');
                        }
                        
                        securityManager.detectSuspiciousActivity('failed_login', { email: sanitizedEmail });
                    }
                    
                    let errorMessage = 'An error occurred. Please try again.';
                    
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already in use. Please login.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email address.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password should be at least 6 characters.';
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = 'User not found. Please sign up.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password.';
                    } else if (error.code === 'auth/invalid-credential') {
                        errorMessage = 'Invalid credentials. Please check your email and password.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Too many failed attempts. Please try again later.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = 'Network error. Please check your connection.';
                    }
                    
                    showToast(errorMessage, 'error');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-gray-100 flex items-center justify-center p-4">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
                        <div className="text-center mb-8">
                            <div className="text-4xl mb-2">üîí</div>
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">ProConnect</h1>
                            <p className="text-gray-600">Ultra Secured Messaging</p>
                            <div className="mt-2 inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs">
                                Enterprise-Grade Security
                            </div>
                        </div>

                        <div className="flex bg-gray-100 rounded-lg p-1 mb-6">
                            <button
                                onClick={() => {
                                    setIsLogin(true);
                                    setPasswordStrength(null);
                                }}
                                className={`flex-1 py-2 rounded-md font-medium transition-all ${
                                    isLogin ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'
                                }`}
                            >
                                Login
                            </button>
                            <button
                                onClick={() => {
                                    setIsLogin(false);
                                    setPasswordStrength(null);
                                }}
                                className={`flex-1 py-2 rounded-md font-medium transition-all ${
                                    !isLogin ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'
                                }`}
                            >
                                Sign Up
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Email Address
                                </label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                                    placeholder="you@example.com"
                                    required
                                    autoComplete="email"
                                    maxLength="254"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Password
                                </label>
                                <div className="relative">
                                    <input
                                        type={showPassword ? "text" : "password"}
                                        value={password}
                                        onChange={(e) => handlePasswordChange(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition pr-12"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        required
                                        minLength="8"
                                        autoComplete={isLogin ? "current-password" : "new-password"}
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowPassword(!showPassword)}
                                        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                    >
                                        {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                                    </button>
                                </div>
                                {!isLogin && passwordStrength && (
                                    <div className={`mt-2 text-sm ${passwordStrength.valid ? 'text-green-600' : 'text-red-600'}`}>
                                        {passwordStrength.message}
                                    </div>
                                )}
                            </div>

                            {!isLogin && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-xs text-blue-800">
                                    <p className="font-semibold mb-1">Password Requirements:</p>
                                    <ul className="list-disc list-inside space-y-1">
                                        <li>At least 8 characters</li>
                                        <li>One uppercase letter</li>
                                        <li>One lowercase letter</li>
                                        <li>One number</li>
                                        <li>One special character</li>
                                    </ul>
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors disabled:bg-blue-400 disabled:cursor-not-allowed"
                            >
                                {loading ? (
                                    <span className="flex items-center justify-center">
                                        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Processing...
                                    </span>
                                ) : (
                                    <>
                                        üîí {isLogin ? 'Secure Login' : 'Create Secure Account'}
                                    </>
                                )}
                            </button>
                        </form>

                        <p className="text-center text-sm text-gray-600 mt-6">
                            {isLogin ? "Don't have an account? " : "Already have an account? "}
                            <button
                                onClick={() => {
                                    setIsLogin(!isLogin);
                                    setPasswordStrength(null);
                                }}
                                className="text-blue-600 font-medium hover:underline"
                            >
                                {isLogin ? 'Sign Up' : 'Login'}
                            </button>
                        </p>

                        <div className="mt-6 pt-6 border-t border-gray-200">
                            <div className="text-xs text-center text-gray-500 space-y-1">
                                <p>üîê End-to-End Encrypted</p>
                                <p>üõ°Ô∏è Rate Limited & CSRF Protected</p>
                                <p>üö® Brute Force Protection Active</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Incoming Call Modal
        const IncomingCallModal = ({ caller, callType, onAccept, onReject }) => {
            const sanitizedCaller = securityManager.sanitizeHTML(caller);
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(caller)}&background=3b82f6&color=fff&size=128`;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4">
                        <div className="text-center">
                            <div className="relative inline-block mb-4">
                                <img src={avatarUrl} alt={sanitizedCaller} className="w-24 h-24 rounded-full" />
                                <div className="absolute inset-0 rounded-full border-4 border-blue-500 pulse-ring"></div>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">{sanitizedCaller}</h2>
                            <p className="text-gray-600 mb-6">
                                Incoming {callType === 'video' ? 'video' : 'voice'} call...
                            </p>
                            <div className="flex space-x-4">
                                <button
                                    onClick={onReject}
                                    className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-full font-semibold transition-colors"
                                >
                                    <svg className="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <button
                                    onClick={onAccept}
                                    className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-full font-semibold transition-colors"
                                >
                                    <svg className="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Video Call Component (simplified for security)
        const VideoCallScreen = ({ friendEmail, friendId, callType, onEndCall }) => {
            const { currentUser } = useAuth();
            const [isMuted, setIsMuted] = useState(false);
            const [isVideoOff, setIsVideoOff] = useState(false);
            const [callDuration, setCallDuration] = useState(0);
            const localVideoRef = useRef(null);
            const remoteVideoRef = useRef(null);
            const peerConnectionRef = useRef(null);
            const localStreamRef = useRef(null);
            const callStartTimeRef = useRef(Date.now());

            useEffect(() => {
                const timer = setInterval(() => {
                    setCallDuration(Math.floor((Date.now() - callStartTimeRef.current) / 1000));
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                initializeCall();
                return () => {
                    cleanup();
                };
            }, []);

            const initializeCall = async () => {
                try {
                    const constraints = callType === 'video'
                        ? { video: true, audio: true }
                        : { video: false, audio: true };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    localStreamRef.current = stream;
                    
                    if (localVideoRef.current) {
                        localVideoRef.current.srcObject = stream;
                    }

                    const peerConnection = new RTCPeerConnection(STUN_SERVERS);
                    peerConnectionRef.current = peerConnection;

                    stream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, stream);
                    });

                    peerConnection.ontrack = (event) => {
                        if (remoteVideoRef.current) {
                            remoteVideoRef.current.srcObject = event.streams[0];
                        }
                    };

                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            db.collection('calls').doc(getChatId(currentUser.uid, friendId))
                                .collection('candidates').add(event.candidate.toJSON())
                                .catch(err => console.error('ICE candidate error:', err));
                        }
                    };
                } catch (error) {
                    console.error('Error initializing call:', error);
                    alert('Failed to access camera/microphone. Please check permissions.');
                    securityManager.detectSuspiciousActivity('call_init_error', { error: error.message });
                }
            };

            const cleanup = () => {
                if (localStreamRef.current) {
                    localStreamRef.current.getTracks().forEach(track => track.stop());
                }
                if (peerConnectionRef.current) {
                    peerConnectionRef.current.close();
                }
            };

            const toggleMute = () => {
                if (localStreamRef.current) {
                    const audioTrack = localStreamRef.current.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        setIsMuted(!audioTrack.enabled);
                    }
                }
            };

            const toggleVideo = () => {
                if (localStreamRef.current && callType === 'video') {
                    const videoTrack = localStreamRef.current.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.enabled = !videoTrack.enabled;
                        setIsVideoOff(!videoTrack.enabled);
                    }
                }
            };

            const formatDuration = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            const sanitizedEmail = securityManager.sanitizeHTML(friendEmail);

            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col">
                    <div className="absolute top-0 left-0 right-0 bg-gradient-to-b from-black/50 to-transparent p-6 z-10">
                        <div className="text-center text-white">
                            <h2 className="text-xl font-semibold">{sanitizedEmail}</h2>
                            <p className="text-sm opacity-75">üîí Encrypted ‚Ä¢ {formatDuration(callDuration)}</p>
                        </div>
                    </div>

                    <div className="flex-1 relative">
                        <video
                            ref={remoteVideoRef}
                            autoPlay
                            playsInline
                            className="remote-video"
                        />
                        {callType === 'video' && (
                            <video
                                ref={localVideoRef}
                                autoPlay
                                playsInline
                                muted
                                className="local-video"
                            />
                        )}
                        {callType === 'audio' && (
                            <div className="absolute inset-0 flex items-center justify-center">
                                <div className="text-center">
                                    <div className="w-32 h-32 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                                        <svg className="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                        </svg>
                                    </div>
                                    <h3 className="text-white text-xl font-semibold">{sanitizedEmail}</h3>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/50 to-transparent p-8 z-10">
                        <div className="flex justify-center space-x-6">
                            <button
                                onClick={toggleMute}
                                className={`w-14 h-14 rounded-full ${isMuted ? 'bg-red-500' : 'bg-gray-700'} hover:bg-opacity-80 transition-colors flex items-center justify-center`}
                            >
                                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    {isMuted ? (
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                                    ) : (
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                    )}
                                </svg>
                            </button>

                            {callType === 'video' && (
                                <button
                                    onClick={toggleVideo}
                                    className={`w-14 h-14 rounded-full ${isVideoOff ? 'bg-red-500' : 'bg-gray-700'} hover:bg-opacity-80 transition-colors flex items-center justify-center`}
                                >
                                    <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                            )}

                            <button
                                onClick={() => {
                                    cleanup();
                                    onEndCall();
                                }}
                                className="w-14 h-14 rounded-full bg-red-500 hover:bg-red-600 transition-colors flex items-center justify-center"
                            >
                                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Typing Indicator Component
        const TypingIndicator = () => {
            return (
                <div className="flex items-center space-x-2 p-4">
                    <div className="bg-gray-200 rounded-2xl rounded-bl-none px-4 py-3">
                        <div className="flex space-x-1">
                            <div className="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div>
                            <div className="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div>
                            <div className="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div>
                        </div>
                    </div>
                </div>
            );
        };

        // Continue with remaining components in next message due to length...
        // Message Component with Encryption
        const Message = ({ message, isOwn }) => {
            const [imageLoaded, setImageLoaded] = useState(false);
            const [decryptedText, setDecryptedText] = useState('');

            useEffect(() => {
                if (message.text) {
                    // Try to decrypt message
                    const decrypted = securityManager.decryptMessage(message.text);
                    setDecryptedText(decrypted || message.text);
                }
            }, [message.text]);

            const sanitizedText = securityManager.sanitizeHTML(decryptedText);

            return (
                <div className={`flex ${isOwn ? 'justify-end' : 'justify-start'} mb-4`}>
                    <div
                        className={`max-w-xs lg:max-w-md rounded-2xl ${
                            isOwn
                                ? 'bg-blue-600 text-white rounded-br-none'
                                : 'bg-gray-200 text-gray-800 rounded-bl-none'
                        }`}
                    >
                        {message.imageUrl && (
                            <img
                                src={message.imageUrl}
                                alt="Shared"
                                className={`rounded-t-2xl max-w-full ${imageLoaded ? '' : 'animate-pulse bg-gray-300'}`}
                                onLoad={() => setImageLoaded(true)}
                                referrerPolicy="no-referrer"
                            />
                        )}
                        {decryptedText && (
                            <div className="px-4 py-2">
                                <p className="break-words" dangerouslySetInnerHTML={{ __html: sanitizedText }}></p>
                            </div>
                        )}
                        <div className="px-4 pb-2 flex items-center space-x-2">
                            <span className={`text-xs ${isOwn ? 'text-blue-100' : 'text-gray-500'}`}>
                                {formatTimestamp(message.timestamp)}
                            </span>
                            {isOwn && message.encrypted && <span className="text-xs">üîí</span>}
                            {isOwn && message.read && <span className="text-xs">‚úì‚úì</span>}
                        </div>
                    </div>
                </div>
            );
        };

        // Chat List Item Component
        const ChatListItem = ({ chat, onClick, isActive }) => {
            const { currentUser } = useAuth();
            const [friendData, setFriendData] = useState(null);

            useEffect(() => {
                const friendId = chat.participants?.find(id => id !== currentUser?.uid);
                if (friendId) {
                    const unsubscribe = db.collection('users').doc(friendId).onSnapshot(doc => {
                        if (doc.exists) {
                            setFriendData(doc.data());
                        }
                    }, err => {
                        console.error('Friend data error:', err);
                        securityManager.detectSuspiciousActivity('friend_data_error', { error: err.message });
                    });
                    return unsubscribe;
                }
            }, [chat, currentUser]);

            if (!friendData) return null;

            const sanitizedEmail = securityManager.sanitizeHTML(friendData.email);
            const sanitizedLastMessage = securityManager.sanitizeHTML(chat.lastMessage || 'No messages yet');
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(friendData.email)}&background=3b82f6&color=fff&size=128`;

            return (
                <div
                    onClick={onClick}
                    className={`flex items-center space-x-3 p-4 cursor-pointer transition-colors border-b border-gray-100 ${
                        isActive ? 'bg-blue-50' : 'hover:bg-gray-50'
                    }`}
                >
                    <div className="relative">
                        <img
                            src={avatarUrl}
                            alt={sanitizedEmail}
                            className="w-12 h-12 rounded-full"
                            referrerPolicy="no-referrer"
                        />
                        {friendData.online && (
                            <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                        )}
                    </div>
                    <div className="flex-1 min-w-0">
                        <h3 className="font-semibold text-gray-800 truncate">{sanitizedEmail}</h3>
                        <p className="text-sm text-gray-500 truncate">{sanitizedLastMessage}</p>
                    </div>
                    <div className="text-right">
                        <span className="text-xs text-gray-400 block">{formatTimestamp(chat.timestamp)}</span>
                        {chat.unreadCount > 0 && (
                            <span className="inline-block mt-1 bg-blue-600 text-white text-xs px-2 py-0.5 rounded-full">
                                {chat.unreadCount > 99 ? '99+' : chat.unreadCount}
                            </span>
                        )}
                    </div>
                </div>
            );
        };

        // Enhanced Chat Window with Security
        const ChatWindow = ({ chatId, friendEmail, friendId, onBack }) => {
            const { currentUser } = useAuth();
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [loading, setLoading] = useState(false);
            const [isTyping, setIsTyping] = useState(false);
            const [friendTyping, setFriendTyping] = useState(false);
            const [showCallMenu, setShowCallMenu] = useState(false);
            const [inCall, setInCall] = useState(false);
            const [callType, setCallType] = useState(null);
            const [incomingCall, setIncomingCall] = useState(null);
            const [toast, setToast] = useState(null);
            const messagesEndRef = useRef(null);
            const typingTimeoutRef = useRef(null);
            const fileInputRef = useRef(null);

            const showToast = (message, type = 'info') => {
                setToast({ message, type });
            };

            useEffect(() => {
                if (!chatId) return;

                const unsubscribe = db
                    .collection('chats')
                    .doc(chatId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .limit(100) // Security: Limit messages loaded
                    .onSnapshot(snapshot => {
                        const msgs = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setMessages(msgs);
                    }, err => {
                        console.error('Messages error:', err);
                        securityManager.detectSuspiciousActivity('messages_error', { error: err.message });
                    });

                return unsubscribe;
            }, [chatId]);

            useEffect(() => {
                if (!chatId) return;

                const unsubscribe = db
                    .collection('chats')
                    .doc(chatId)
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            const typingUserId = data.typing;
                            setFriendTyping(typingUserId === friendId);
                        }
                    }, err => {
                        console.error('Typing status error:', err);
                    });

                return unsubscribe;
            }, [chatId, friendId]);

            useEffect(() => {
                if (!chatId) return;

                const unsubscribe = db
                    .collection('calls')
                    .doc(chatId)
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const callData = doc.data();
                            if (callData.status === 'calling' && callData.to === currentUser.uid) {
                                setIncomingCall({
                                    from: callData.from,
                                    type: callData.type,
                                    caller: friendEmail
                                });
                            } else if (callData.status === 'ended') {
                                setInCall(false);
                                setIncomingCall(null);
                            }
                        }
                    }, err => {
                        console.error('Call status error:', err);
                    });

                return unsubscribe;
            }, [chatId, currentUser, friendEmail]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages, friendTyping]);

            // Activity refresh
            useEffect(() => {
                const activityInterval = setInterval(() => {
                    if (currentUser) {
                        securityManager.refreshSession();
                    }
                }, 30000); // Every 30 seconds

                return () => clearInterval(activityInterval);
            }, [currentUser]);

            const handleTyping = (text) => {
                // Rate limit check
                if (!securityManager.checkRateLimit(currentUser.uid)) {
                    showToast('You are typing too fast. Please slow down.', 'error');
                    return;
                }

                const sanitized = securityManager.sanitizeInput(text);
                if (sanitized.length > SECURITY_CONFIG.MAX_MESSAGE_LENGTH) {
                    showToast(`Message too long. Max ${SECURITY_CONFIG.MAX_MESSAGE_LENGTH} characters.`, 'error');
                    return;
                }

                setNewMessage(text);
                
                if (!isTyping) {
                    setIsTyping(true);
                    db.collection('chats').doc(chatId).set({
                        typing: currentUser.uid
                    }, { merge: true }).catch(err => console.error('Error updating typing status:', err));
                }

                if (typingTimeoutRef.current) {
                    clearTimeout(typingTimeoutRef.current);
                }

                typingTimeoutRef.current = setTimeout(() => {
                    setIsTyping(false);
                    db.collection('chats').doc(chatId).set({
                        typing: null
                    }, { merge: true }).catch(err => console.error('Error clearing typing status:', err));
                }, 2000);
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file
                const validation = securityManager.validateFile(file);
                if (!validation.valid) {
                    showToast(validation.message, 'error');
                    return;
                }

                // Rate limit check
                if (!securityManager.checkRateLimit(currentUser.uid)) {
                    showToast('Too many uploads. Please wait.', 'error');
                    return;
                }

                setLoading(true);
                try {
                    const storageRef = storage.ref();
                    const secureFileName = `${securityManager.generateSecureRandom(16)}_${Date.now()}.${file.name.split('.').pop()}`;
                    const imageRef = storageRef.child(`chat-images/${currentUser.uid}/${secureFileName}`);
                    
                    await imageRef.put(file, {
                        contentType: file.type,
                        customMetadata: {
                            uploadedBy: currentUser.uid,
                            originalName: file.name
                        }
                    });
                    
                    const imageUrl = await imageRef.getDownloadURL();

                    const messageData = {
                        imageUrl,
                        text: '',
                        senderId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false,
                        encrypted: false
                    };

                    await db.collection('chats').doc(chatId).collection('messages').add(messageData);
                    
                    await db.collection('chats').doc(chatId).set({
                        lastMessage: 'üì∑ Image',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    showToast('Image sent securely', 'success');
                } catch (error) {
                    console.error('Error uploading image:', error);
                    showToast('Failed to upload image', 'error');
                    securityManager.detectSuspiciousActivity('image_upload_error', { error: error.message });
                } finally {
                    setLoading(false);
                    if (fileInputRef.current) fileInputRef.current.value = '';
                }
            };

            const handleSend = async (e) => {
                e.preventDefault();
                
                const trimmed = newMessage.trim();
                if (!trimmed || loading) return;

                // Rate limit check
                if (!securityManager.checkRateLimit(currentUser.uid)) {
                    showToast('You are sending too fast. Please slow down.', 'error');
                    return;
                }

                // Sanitize and validate
                const sanitized = securityManager.sanitizeInput(trimmed);
                if (sanitized.length > SECURITY_CONFIG.MAX_MESSAGE_LENGTH) {
                    showToast(`Message too long. Max ${SECURITY_CONFIG.MAX_MESSAGE_LENGTH} characters.`, 'error');
                    return;
                }

                setLoading(true);
                setIsTyping(false);
                
                try {
                    // Encrypt message
                    const encrypted = securityManager.encryptMessage(sanitized);
                    if (!encrypted) {
                        throw new Error('Encryption failed');
                    }

                    const messageData = {
                        text: encrypted,
                        senderId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false,
                        encrypted: true
                    };

                    await db.collection('chats').doc(chatId).collection('messages').add(messageData);
                    
                    await db.collection('chats').doc(chatId).set({
                        lastMessage: 'üîí ' + sanitized.substring(0, 50),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        typing: null
                    }, { merge: true});

                    setNewMessage('');
                } catch (error) {
                    console.error('Error sending message:', error);
                    showToast('Failed to send message', 'error');
                    securityManager.detectSuspiciousActivity('message_send_error', { error: error.message });
                } finally {
                    setLoading(false);
                }
            };

            const initiateCall = async (type) => {
                try {
                    await db.collection('calls').doc(chatId).set({
                        from: currentUser.uid,
                        to: friendId,
                        type: type,
                        status: 'calling',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setCallType(type);
                    setInCall(true);
                    setShowCallMenu(false);
                } catch (error) {
                    console.error('Error initiating call:', error);
                    showToast('Failed to initiate call', 'error');
                }
            };

            const acceptCall = async () => {
                try {
                    await db.collection('calls').doc(chatId).update({
                        status: 'active'
                    });
                    setCallType(incomingCall.type);
                    setInCall(true);
                    setIncomingCall(null);
                } catch (error) {
                    console.error('Error accepting call:', error);
                    showToast('Failed to accept call', 'error');
                }
            };

            const rejectCall = async () => {
                try {
                    await db.collection('calls').doc(chatId).update({
                        status: 'ended'
                    });
                    setIncomingCall(null);
                } catch (error) {
                    console.error('Error rejecting call:', error);
                }
            };

            const endCall = async () => {
                try {
                    await db.collection('calls').doc(chatId).update({
                        status: 'ended'
                    });
                    setInCall(false);
                    setCallType(null);
                } catch (error) {
                    console.error('Error ending call:', error);
                }
            };

            if (inCall) {
                return (
                    <VideoCallScreen
                        friendEmail={friendEmail}
                        friendId={friendId}
                        callType={callType}
                        onEndCall={endCall}
                    />
                );
            }

            const sanitizedEmail = securityManager.sanitizeHTML(friendEmail);
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(friendEmail)}&background=3b82f6&color=fff&size=128`;

            return (
                <div className="flex flex-col h-full">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {incomingCall && (
                        <IncomingCallModal
                            caller={incomingCall.caller}
                            callType={incomingCall.type}
                            onAccept={acceptCall}
                            onReject={rejectCall}
                        />
                    )}

                    {/* Chat Header */}
                    <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center space-x-3">
                        <button
                            onClick={onBack}
                            className="lg:hidden text-gray-600 hover:text-gray-800 mr-2"
                        >
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <img 
                            src={avatarUrl} 
                            alt={sanitizedEmail} 
                            className="w-10 h-10 rounded-full" 
                            referrerPolicy="no-referrer"
                        />
                        <div className="flex-1">
                            <h2 className="font-semibold text-gray-800 flex items-center space-x-2">
                                <span>{sanitizedEmail}</span>
                                <span className="text-xs">üîí</span>
                            </h2>
                            <p className="text-xs text-green-500">Online ‚Ä¢ Encrypted</p>
                        </div>
                        <div className="relative">
                            <button
                                onClick={() => setShowCallMenu(!showCallMenu)}
                                className="text-gray-600 hover:text-blue-600 transition-colors p-2"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                </svg>
                            </button>
                            {showCallMenu && (
                                <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-10">
                                    <button
                                        onClick={() => initiateCall('audio')}
                                        className="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center space-x-3"
                                    >
                                        <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                        </svg>
                                        <span>Voice Call</span>
                                    </button>
                                    <button
                                        onClick={() => initiateCall('video')}
                                        className="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center space-x-3"
                                    >
                                        <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                        </svg>
                                        <span>Video Call</span>
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Messages Area */}
                    <div className="flex-1 overflow-y-auto chat-scroll bg-gray-50 p-4">
                        {messages.length === 0 ? (
                            <div className="flex items-center justify-center h-full">
                                <div className="text-center">
                                    <div className="text-4xl mb-2">üîí</div>
                                    <p className="text-gray-400">No messages yet</p>
                                    <p className="text-xs text-gray-400 mt-2">Messages are end-to-end encrypted</p>
                                </div>
                            </div>
                        ) : (
                            <>
                                {messages.map(msg => (
                                    <Message
                                        key={msg.id}
                                        message={msg}
                                        isOwn={msg.senderId === currentUser.uid}
                                    />
                                ))}
                                {friendTyping && <TypingIndicator />}
                            </>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="bg-white border-t border-gray-200 p-4">
                        <form onSubmit={handleSend} className="flex items-center space-x-2">
                            <input
                                type="file"
                                ref={fileInputRef}
                                onChange={handleImageUpload}
                                accept="image/jpeg,image/png,image/gif,image/webp"
                                className="hidden"
                            />
                            <button
                                type="button"
                                onClick={() => fileInputRef.current?.click()}
                                disabled={loading}
                                className="text-gray-600 hover:text-blue-600 transition-colors disabled:opacity-50 p-2"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </button>
                            <input
                                type="text"
                                value={newMessage}
                                onChange={(e) => handleTyping(e.target.value)}
                                placeholder="Type a secure message..."
                                className="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                                disabled={loading}
                                maxLength={SECURITY_CONFIG.MAX_MESSAGE_LENGTH}
                            />
                            <button
                                type="submit"
                                disabled={loading || !newMessage.trim()}
                                className="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full transition-colors disabled:bg-blue-400 disabled:cursor-not-allowed"
                            >
                                {loading ? (
                                    <svg className="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                ) : (
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                    </svg>
                                )}
                            </button>
                        </form>
                        <p className="text-xs text-center text-gray-400 mt-2">
                            üîí End-to-end encrypted ‚Ä¢ {newMessage.length}/{SECURITY_CONFIG.MAX_MESSAGE_LENGTH}
                        </p>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const { currentUser } = useAuth();
            const [selectedChat, setSelectedChat] = useState(null);
            const [chats, setChats] = useState([]);
            const [toast, setToast] = useState(null);

            const showToast = (message, type = 'info') => {
                setToast({ message, type });
            };

            useEffect(() => {
                if (!currentUser) return;

                const unsubscribe = db
                    .collection('chats')
                    .where('participants', 'array-contains', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(snapshot => {
                        const chatList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setChats(chatList);
                    }, err => {
                        console.error('Chats error:', err);
                        securityManager.detectSuspiciousActivity('chats_error', { error: err.message });
                    });

                return unsubscribe;
            }, [currentUser]);

            if (!currentUser) {
                return <AuthPage />;
            }

            return (
                <div className="h-screen flex bg-gray-100">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {/* Sidebar */}
                    <div className={`w-full lg:w-96 bg-white border-r border-gray-200 flex flex-col ${
                        selectedChat ? 'hidden lg:flex' : 'flex'
                    }`}>
                        {/* Sidebar Header */}
                        <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h1 className="text-2xl font-bold flex items-center space-x-2">
                                    <span>üîí</span>
                                    <span>ProConnect</span>
                                </h1>
                                <button
                                    onClick={async () => {
                                        try {
                                            await auth.signOut();
                                            showToast('Logged out successfully', 'success');
                                        } catch (error) {
                                            console.error('Logout error:', error);
                                            showToast('Logout failed', 'error');
                                        }
                                    }}
                                    className="text-white hover:text-gray-200 transition-colors"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                    </svg>
                                </button>
                            </div>
                            <p className="text-sm text-blue-100">{securityManager.sanitizeHTML(currentUser.email)}</p>
                            <div className="mt-2 text-xs bg-blue-800 bg-opacity-50 px-3 py-1 rounded-full inline-block">
                                Ultra Secured Mode
                            </div>
                        </div>

                        {/* Chat List */}
                        <div className="flex-1 overflow-y-auto">
                            {chats.length === 0 ? (
                                <div className="flex items-center justify-center h-full">
                                    <div className="text-center p-8">
                                        <div className="text-4xl mb-4">üí¨</div>
                                        <p className="text-gray-500">No conversations yet</p>
                                        <p className="text-sm text-gray-400 mt-2">Add friends to start chatting</p>
                                    </div>
                                </div>
                            ) : (
                                chats.map(chat => (
                                    <ChatListItem
                                        key={chat.id}
                                        chat={chat}
                                        onClick={() => setSelectedChat(chat)}
                                        isActive={selectedChat?.id === chat.id}
                                    />
                                ))
                            )}
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className={`flex-1 flex flex-col ${
                        selectedChat ? 'flex' : 'hidden lg:flex'
                    }`}>
                        {selectedChat ? (
                            <ChatWindow
                                chatId={selectedChat.id}
                                friendEmail={selectedChat.friendEmail || 'Friend'}
                                friendId={selectedChat.participants?.find(id => id !== currentUser.uid)}
                                onBack={() => setSelectedChat(null)}
                            />
                        ) : (
                            <div className="flex items-center justify-center h-full bg-gray-50">
                                <div className="text-center">
                                    <div className="text-6xl mb-4">üîí</div>
                                    <h2 className="text-2xl font-semibold text-gray-800 mb-2">ProConnect Secured</h2>
                                    <p className="text-gray-500">Select a conversation to start messaging</p>
                                    <div className="mt-6 space-y-2 text-sm text-gray-400">
                                        <p>‚úì End-to-End Encryption</p>
                                        <p>‚úì Rate Limiting Protection</p>
                                        <p>‚úì XSS & CSRF Protected</p>
                                        <p>‚úì Brute Force Prevention</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <AuthProvider>
                <App />
            </AuthProvider>
        );
    </script>
</body>
</html>